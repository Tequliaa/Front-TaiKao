<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SurveySystem.Mapper.QuestionMapper">

    <resultMap id="questionResultMap" type="Question">
        <id property="questionId" column="questionId"/>
        <result property="surveyId" column="surveyId"/>
        <result property="description" column="description"/>
        <result property="type" column="type"/>
        <result property="isRequired" column="isRequired"/>
        <result property="isOpen" column="isOpen"/>
        <result property="displayType" column="displayType"/>
        <result property="isSkip" column="isSkip"/>
        <result property="minSelect" column="minSelect"/>
        <result property="maxSelect" column="maxSelect"/>
        <result property="createdAt" column="createdAt"/>
        <result property="updatedAt" column="updatedAt"/>
        <result property="categoryId" column="CategoryId"/>
        <result property="surveyName" column="surveyName"/>
        <result property="categoryName" column="categoryName"/>
    </resultMap>

    <sql id="baseQuery">
        SELECT
            q.question_id AS questionId,
            q.survey_id AS surveyId,
            q.description,
            q.type,
            q.is_required AS isRequired,
            q.is_open AS isOpen,
            q.display_type AS displayType,
            q.is_skip AS isSkip,
            q.min_select AS minSelect,
            q.max_select AS maxSelect,
            q.created_at AS createdAt,
            q.updated_at AS updatedAt,
            q.primary_category_id AS CategoryId,
            s.name AS surveyName,
            c.category_name AS categoryName
        FROM Questions q
                 JOIN Surveys s ON q.survey_id = s.survey_id
                 LEFT JOIN Category c ON q.primary_category_id = c.category_id
    </sql>

    <select id="getAllQuestions" resultMap="questionResultMap">
        <include refid="baseQuery"/>
        <if test="surveyId != 0">
            WHERE q.survey_id = #{surveyId}
        </if>
    </select>

    <select id="getQuestionById" resultMap="questionResultMap" parameterType="int">
        <include refid="baseQuery"/>
        WHERE q.question_id = #{questionId}
    </select>

    <select id="getQuestionsBySurveyId" resultMap="questionResultMap" parameterType="int">
        <include refid="baseQuery"/>
        WHERE q.survey_id = #{surveyId}
    </select>

    <select id="getQuestionsByCategoryId" resultMap="questionResultMap" parameterType="int">
        <include refid="baseQuery"/>
        WHERE q.primary_category_id = #{categoryId}
    </select>

    <insert id="addQuestionAndReturnId" parameterType="Question" useGeneratedKeys="true" keyProperty="questionId" keyColumn="question_id">
        INSERT INTO questions
        (description, type, is_required, is_open, primary_category_id, survey_id, is_skip, min_select, max_select)
        VALUES
            (#{description}, #{type}, #{isRequired}, #{isOpen}, #{categoryId}, #{surveyId}, #{isSkip}, #{minSelect}, #{maxSelect})
    </insert>

    <update id="updateQuestion" parameterType="Question">
        UPDATE questions
        SET
            description = #{description},
            type = #{type},
            is_required = #{isRequired},
            is_open = #{isOpen},
            is_skip = #{isSkip},
            survey_id = #{surveyId},
            primary_category_id = #{categoryId},
            min_select = #{minSelect},
            max_select = #{maxSelect}
        WHERE question_id = #{questionId}
    </update>

    <delete id="deleteQuestion" parameterType="int">
        DELETE FROM questions WHERE question_id = #{questionId}
    </delete>

    <select id="getQuestionsByPage" resultMap="questionResultMap">
        <include refid="baseQuery"/>
        <where>
            <if test="surveyId != 0">
                AND q.survey_id = #{surveyId}
            </if>
            <if test="categoryId != 0">
                AND q.primary_category_id = #{categoryId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND q.description LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <select id="getQuestionCount" resultType="int">
        SELECT COUNT(*) FROM Questions q
        <where>
            <if test="surveyId != 0">
                AND q.survey_id = #{surveyId}
            </if>
            <if test="categoryId != 0">
                AND q.primary_category_id = #{categoryId}
            </if>
            <if test="keyword != null and keyword != ''">
                AND q.description LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <update id="updateSurveyTimestamp" parameterType="int">
        UPDATE surveys SET updated_at = NOW() WHERE survey_id = #{surveyId}
    </update>
</mapper>