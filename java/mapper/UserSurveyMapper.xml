<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SurveySystem.Mapper.UserSurveyMapper">

    <!-- 定义 UserSurvey 的 resultMap -->
    <resultMap id="UserSurveyResultMap" type="UserSurvey">
        <id column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="survey_id" property="surveyId"/>
        <result column="department_id" property="departmentId"/>
        <result column="status" property="status"/>
        <result column="assigned_at" property="assignedAt"/>
        <result column="completed_at" property="completedAt"/>
        <result column="survey_name" property="surveyName"/>
        <result column="description" property="surveyDescription"/>
        <result column="allow_view" property="allowView"/>
        <result column="user_name" property="username"/>
        <result column="department_name" property="departmentName"/>
    </resultMap>

    <!-- 获取未完成的用户列表，带分页和部门名称 -->
    <select id="getUserInfoBySurveyId" resultMap="UserSurveyResultMap">
        SELECT us.user_id, us.status,u.name AS user_name, u.department_id, d.name AS department_name
        FROM user_survey us
        JOIN users u ON us.user_id = u.id
        JOIN departments d ON u.department_id = d.id
        WHERE us.survey_id = #{surveyId} AND us.status != '已完成'
        <if test="departmentId != 0">
            AND u.department_id = #{departmentId}
        </if>
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 获取未完成的用户数量 -->
    <select id="getUserInfoCount" resultType="int">
        SELECT COUNT(*)
        FROM user_survey us
        JOIN users u ON us.user_id = u.id
        WHERE us.survey_id = #{surveyId} AND us.status != '已完成'
        <if test="departmentId != 0">
            AND u.department_id = #{departmentId}
        </if>
    </select>

    <!-- 获取部门相关的用户问卷信息 -->
    <select id="getUserDepartmentInfoBySurveyId" resultMap="UserSurveyResultMap">
        SELECT DISTINCT u.department_id, d.name AS department_name
        FROM user_survey us
                 JOIN users u ON us.user_id = u.id
                 JOIN departments d ON u.department_id = d.id
        WHERE us.survey_id = #{surveyId}
    </select>

    <!-- 获取用户和问卷的记录 -->
    <select id="getUserSurveyByUserIdAndSurveyId" resultMap="UserSurveyResultMap">
        SELECT us.id, us.user_id, us.survey_id, us.status, us.assigned_at, us.completed_at
        FROM user_survey us
        WHERE us.user_id = #{userId} AND us.survey_id = #{surveyId}
    </select>

    <!-- 为部门的用户分配问卷 -->
    <insert id="assignSurveyToDepartment">
        INSERT INTO user_survey (user_id, survey_id, status)
        VALUES
        <foreach collection="users" item="user" separator=",">
            (#{user.id}, #{userSurvey.surveyId}, #{userSurvey.status})
        </foreach>
    </insert>


    <!-- 为用户分配问卷 -->
    <insert id="assignSurveysToUser">
        INSERT INTO user_survey (user_id, survey_id)
        VALUES
        <foreach collection="departmentSurveys" item="survey" separator=",">
            (#{userId}, #{survey.surveyId})
        </foreach>
    </insert>

    <!-- 为用户分配问卷 -->
    <insert id="assignSurveysToUsers">
        INSERT IGNORE INTO user_survey (user_id, survey_id)
        VALUES
        <foreach collection="users" item="user" separator=",">
            <foreach collection="departmentSurveys" item="survey" separator=",">
                (#{user.id}, #{survey.surveyId})
            </foreach>
        </foreach>
    </insert>

    <!-- 新增用户问卷记录 -->
    <insert id="addUserSurvey">
        INSERT INTO user_survey (user_id, survey_id, status)
        VALUES (#{userSurvey.userId}, #{userSurvey.surveyId}, #{userSurvey.status})
    </insert>

    <!-- 更新问卷状态 -->
    <update id="updateSurveyStatus">
        UPDATE user_survey
        SET status = #{status}, completed_at = #{completedAt}
        WHERE id = #{id}
    </update>

    <!-- 更新问卷状态（根据survey_id和user_id） -->
    <update id="updateSurveyStatusBySurveyAndUser">
        UPDATE user_survey
        SET status = #{status}, completed_at = #{completedAt}
        WHERE survey_id = #{surveyId} AND user_id = #{userId}
    </update>

    <!-- 查询用户问卷，支持分页和关键字搜索 -->
    <select id="getSurveysByUserId" resultMap="UserSurveyResultMap">
        SELECT us.id, us.user_id, us.survey_id, us.status, us.assigned_at, us.completed_at,
        s.name AS survey_name, s.description, s.allow_view,
        u.name AS user_name  <!-- 添加用户名 -->
        FROM user_survey us
        JOIN surveys s ON us.survey_id = s.survey_id
        JOIN users u ON us.user_id = u.id  <!-- 新增关联users表 -->
        WHERE us.user_id = #{userId}
        <if test="keyword != null and keyword != ''">
            AND (s.name LIKE CONCAT('%', #{keyword}, '%')
            OR s.description LIKE CONCAT('%', #{keyword}, '%')
            OR u.name LIKE CONCAT('%', #{keyword}, '%'))  <!-- 可选：用户名也加入搜索 -->
        </if>
        ORDER BY us.assigned_at DESC  <!-- 建议添加排序 -->
        LIMIT #{pageSize} OFFSET #{offset}
    </select>

    <!-- 获取用户的问卷总数，支持关键字搜索 -->
    <select id="getSurveyCountByUserId" resultType="int">
        SELECT COUNT(*)
        FROM user_survey us
        JOIN surveys s ON us.survey_id = s.survey_id
        WHERE us.user_id = #{userId}
        <if test="keyword != null and keyword != ''">
            AND (s.name LIKE CONCAT('%', #{keyword}, '%') OR s.description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

</mapper>
